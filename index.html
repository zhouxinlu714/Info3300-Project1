<!-- <!DOCTYPE html> -->
<html>
    <head>
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <style>
        body {
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                width: 960px;
                height: 500px;
                position: relative;
            }
            .gridlines line {
                stroke: #ddd;
            }

            .gridlines .domain {
                stroke: none;
            }
            .y.label{
                font: 14px Helvetica;
            }
        </style>
    </head>
    <body>
        <h1>Project 1</h1>
        <h3>Sijin Li (sl2624)
            Xinlu Zhou (xz633)
        </h3>
        <svg id="datavis" height="800" , width="800", style="margin-left: 20px">
            <text id="label" x='790' y= '420' text-anchor="end" alignment-baseline="hanging"></text>
        </svg>
        <script>
            d3.csv("./happiness.csv", d3.autoType).then(data => {
                let topdata = data.slice(0,10);
                topdata.forEach( d => {
                  d["dystopia"] = 1.85;
                  data_sum = d["Freedom to make life choices"] + d["GDP per capita"]+ d["Generosity"]+
                  d["Healthy life expectancy"]+d["Perceptions of corruption"]+d["Social support"];
                  d["unexpected"] = (d["Score"] - d["dystopia"]-data_sum).toFixed(3);
                  d["unexpected"] = Number(d["unexpected"]);
                });


                const svg = d3.select("svg#datavis");
                const width = svg.attr("width");
                const height = svg.attr("height");
                const margin = { top: 10, right: 10, bottom: 200, left: 60 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                topdata.forEach( (d, i) => {
                    d['country'] = d['Country or region'];
                    });

                let annotations = svg.append("g").attr("id", "annotations");
                let plot = svg.append("g")
                              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                let tips = svg.append("g").attr("id", "tips");

                const scoreExtent = d3.extent(topdata, d => d['Score']);
                const yScale = d3.scaleLinear().domain([0, 10]).range([chartHeight, 0]);
                console.log("score extent", scoreExtent)

                const genres = d3.map(topdata, d => d.country)
                console.log(genres)
                const xScale = d3.scaleBand().domain(genres).range([0, chartWidth])
                             .padding(0.05);

                //axis-x
                let bottomAxis = d3.axisBottom(xScale)
                annotations.append("g")
                .attr("class", "x axis")
                .attr("transform",`translate(${margin.left},${chartHeight+margin.top+10})`)
                .call(bottomAxis);

                //axis-y
                let leftAxis = d3.axisLeft(yScale);
                let leftGridlines = d3.axisLeft(yScale)
                                  .tickSize(-chartWidth-20)
                                  .tickFormat("");

                annotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(" + (margin.left - 20) + "," + margin.top + ")")
                    .call(leftAxis)

                annotations.append("text")
                    .attr("class", "y label")
                    .attr("text-anchor", "end")
                    .attr("y", 6)
                    .attr("dy", ".75em")
                    .attr("transform", "rotate(-90)")
                    .attr("text-anchor", "end")
                    .text("happiness rating");

                annotations.append("g")
                    .attr("class", "y gridlines")
                    .attr("transform", "translate(" + (margin.left - 20) + "," + margin.top + ")")
                    .call(leftGridlines);

                var stackedData = d3.stack()
                .keys(data.columns.slice(1))(topdata)

                var stack = d3.stack()
                .keys(["Freedom to make life choices", "GDP per capita", "Generosity", "Healthy life expectancy","Perceptions of corruption","Social support","dystopia","unexpected"])
                .order(d3.stackOrderNone)
                .offset(d3.stackOffsetNone);

                var series = stack(topdata);
                // var series = stack(stackedData);

                console.log("series", series)

                const color = d3.scaleOrdinal().domain(genres).range(['#003f5c','#444e86','#955196','#dd5182','#ff6e54','#ffa600', "#18D6B1", "#18D5D6"])
                const rects = plot.selectAll("g").data(series).enter()
                    .append("g")
                    .attr("fill", d => color(d.key));

                var padding = 40;

                var box = tips.append("rect")
                .style("opacity", 0)
                .style("fill", "white")
                .style("stroke", "black")
                .style("stroke-width", "2px")
                .attr("width", "100")
                .attr("height", "50")
                .attr("rx", "15")
                .attr("ry", "15");

                var Mouseover = function(d){
                  let cur_x = d3.select(this).attr("x");
                  let cur_y = d3.select(this).attr("y");
                  box.style("opacity", 1)
                     .attr("x", cur_x+20)
                     .attr("y", cur_y+20);
                  d3.select(this)
                    .style("stroke", "black")
                    // .style("opacity", 1);
                }

                var Mousemove = function(d){
                  let cur_x = d3.select(this).attr("x");
                  let cur_y = d3.select(this).attr("y");
                  box.style("opacity", 0.8)
                     .attr("x", cur_x+20)
                     .attr("y", cur_y+20);
                  d3.select(this)
                    .style("stroke", "black")
                    // .style("opacity", 1);
                }

                var Mouseleave = function(d) {
                  box.style("opacity", 0);
                  d3.select(this)
                    .style("stroke", "none")
                    // .style("opacity", 1);
                }

                // create a tooltip
                var Tooltip = d3.select("body").append("div")
                                .style("opacity", 1)
                                .attr("class", "tooltip")
                                .text("hello!")
                                .style("background-color", "white")
                                .style("border", "solid")
                                .style("border-width", "2px")
                                .style("border-radius", "5px")
                                .style("padding", "5px")
                                .style("position", "absolute")
                                .style("left", "0 px")
                                .style("top", "0 px");




                // // Three function that change the tooltip when user hover / move / leave a cell
                //  var Mouseover = function(d) {
                //
                //    Tooltip
                //      .html("mousemove in tooltip")
                //      .style("opacity", 1)
                //      .style("left", (d3.select(this).attr("x")) + "px")
                //      .style("top", (d3.select(this).attr("y")) + "px")
                //      // .text("a simple tooltip")
                //
                //    d3.select(this)
                //      .style("stroke", "black")
                //      .style("opacity", 1)
                //   console.log(d3.select(this).attr("x"), d3.select(this).attr("y"))
                //  }
                //  var Mousemove = function(d) {
                //    // console.log("mousemove", d3.mouse(this))
                //    Tooltip
                //      .html("mousemove in tooltip")
                //      .style("left", (d3.select(this).attr("x")) + "px")
                //      .style("top", (d3.select(this).attr("y")) + "px")
                //
                //  }
                //  var Mouseleave = function(d) {
                //    Tooltip
                //      .style("opacity", 0)
                //    d3.select(this)
                //      .style("stroke", "none")
                //      .style("opacity", 1)
                //  }
                //


                rects.selectAll("rect")
                    .data(d => d)
                    .join("rect")
                    .attr("x", (d, i) => xScale(d.data.country))
                    .attr("y", d=> yScale(d[1]))
                    .attr("height", d=> yScale(d[0]) - yScale(d[1]))
                    .attr("width", xScale.bandwidth())
                    .attr("label", d=> yScale(d[0]) - yScale(d[1]))
                    .on("mouseover", Mouseover)
                    .on("mousemove", Mousemove)
                    .on("mouseout", Mouseleave);


                var legend = svg.append('g')
                .attr('class', 'legend')
                .attr('transform', 'translate(' + (padding + 12) + ','+ (height-150)  + ')');

                legend.selectAll('rect')
                    .data(series)
                    .enter()
                    .append('rect')
                    .attr('x', 0)
                    .attr('y', function(d,i){
                        return i * 18;
                    })
                    .attr('width', 12)
                    .attr('height', 12)
                    .attr('fill', function(d,i){
                        return color(i);
                    });

                legend.selectAll('text')
                    .data(series)
                    .enter()
                    .append('text')
                    .text(function(d){
                        return d.key;
                    })
                    .attr('x', 15)
                    .attr('y', function(d, i){
                        return i * 18;
                    })
                    .attr('text-anchor', 'start')
                    .attr('alignment-baseline', 'hanging');

            });
        </script>
    </body>
</html>
